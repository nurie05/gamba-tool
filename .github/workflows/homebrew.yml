name: Update Homebrew Formula

on:
  push:
    tags:
      - "v*"  # Trigger when you push a version tag, e.g. v0.2.0

jobs:
  update-homebrew:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout gamba-tool source
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Compute SHA256 for release tarball
        id: sha
        run: |
          URL="https://github.com/${{ github.repository }}/archive/refs/tags/v${{ steps.version.outputs.version }}.tar.gz"
          echo "Downloading $URL"
          curl -L "$URL" -o source.tar.gz
          SHA=$(shasum -a 256 source.tar.gz | cut -d ' ' -f1)
          echo "sha256=$SHA" >> $GITHUB_OUTPUT
          echo "Tarball SHA: $SHA"

      - name: Clone homebrew tap repo
        run: |
          git clone https://github.com/nurie05/homebrew-tools.git tap
          ls tap/Formula

      - name: Update formula file
        run: |
          FORMULA_PATH="tap/Formula/gamba.rb"
          VERSION="${{ steps.version.outputs.version }}"
          SHA="${{ steps.sha.outputs.sha256 }}"
          URL="https://github.com/${{ github.repository }}/archive/refs/tags/v${VERSION}.tar.gz"

          echo "Updating $FORMULA_PATH..."
          sed -i "s|url \".*\"|url \"$URL\"|" "$FORMULA_PATH"
          sed -i "s|sha256 \".*\"|sha256 \"$SHA\"|" "$FORMULA_PATH"
          sed -i "s|version \".*\"|version \"$VERSION\"|" "$FORMULA_PATH" || true

      - name: Commit and push changes to Homebrew tap
        run: |
          cd tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/gamba.rb
          git commit -m "Update gamba formula to v${{ steps.version.outputs.version }}"
          git push https://nurie05:${{ secrets.HOMEBREW_TAP_TOKEN }}@github.com/nurie05/homebrew-tools.git HEAD:main